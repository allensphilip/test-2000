---
import MainLayout from "@/layouts/main.astro"
import { KpiCards } from "@/components/analytics/KpiCards"
import { Filters } from "@/components/analytics/Filters"
import { TrendChart } from "@/components/analytics/TrendChart"
import AnalyticsTabs from "@/components/analytics/AnalyticsTabs"
import { fetchTranscriptionList, fetchSummaryList, fetchCorrections } from "@/lib/analytics-api"

const { user } = Astro.locals as any
if (!user) return Astro.redirect('/login')

const transcription = await fetchTranscriptionList()
const summary = await fetchSummaryList()

const avg = (xs: number[]) => xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : 0
const kpis = [
  { title: "Transcription WER", value: avg(transcription.map(t=>t.wer)).toFixed(3) },
  { title: "Transcription CER", value: avg(transcription.map(t=>t.cer)).toFixed(3) },
  { title: "Summary WER", value: avg(summary.map(s=>s.wer)).toFixed(3) },
  { title: "Summary CER", value: avg(summary.map(s=>s.cer)).toFixed(3) },
]

const trendWer = transcription.slice(0, 20).map(t=>t.wer)
const labels = [] as string[]
const values = [] as number[]
---
<MainLayout content={{ title: "Medsum - Analytics" }} user={user} active="analytics">
  <section>
    <h1>Analytics</h1>
    <KpiCards items={kpis} />
  </section>
  <section style="margin-top:16px;">
    <Filters client:load onChange={() => {}} />
  </section>
  <section style="margin-top:16px;">
    <h3>WER Trend (recent)</h3>
    <TrendChart values={trendWer} />
  </section>
  <AnalyticsTabs client:load />
</MainLayout>
