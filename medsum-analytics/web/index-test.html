<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Summary Analysis Test UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; line-height: 1.5; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { font-weight: 600; display: block; margin-top: 8px; }
    input[type="text"], textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    textarea { min-height: 120px; }
    button { margin-top: 12px; padding: 8px 14px; border: 1px solid #0078d4; background: #0a84ff; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { border-color: #999; background: #f5f5f5; color: #222; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    .status { background: #f7faff; border: 1px dashed #bcd; padding: 8px 12px; border-radius: 6px; white-space: pre-wrap; }
    .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .metric { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 8px; }
    .help { color: #555; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Summary Analysis Tester</h1>
  <div class="card" style="display:flex; gap:8px; align-items:center">
    <button id="tabApi" class="secondary">API</button>
    <button id="tabAnalytics" class="secondary">Analytics</button>
    <span class="help">Switch between MedSum API actions and Analytics actions</span>
    <button id="btnClearStatus" class="secondary" style="margin-left:auto">Clear Status</button>
  </div>
  

  <div class="card" data-section="api">
    <h2>Trigger via MedSum API</h2>
    <div class="row">
      <div class="col">
        <label for="apiUrl">MedSum API URL</label>
        <input id="apiUrl" type="text" placeholder="http://localhost:3000" value="http://localhost:3000" />
      </div>
      <div class="col">
        <label for="apiKey">x-api-key</label>
        <input id="apiKey" type="text" placeholder="client api key" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="adminApiKey">Admin API key</label>
        <input id="adminApiKey" type="text" placeholder="admin api key (default 12345)" value="12345" />
      </div>
      <div class="col">
        <label for="clientName">Client name</label>
        <input id="clientName" type="text" placeholder="e.g. client-a" value="client-a" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button id="btnCreateClient">Create client & fetch x-api-key</button>
        <button id="btnShowClientCurl" class="secondary">Show cURL (create client)</button>
        <button id="btnListClients" class="secondary">List clients</button>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="application">Application</label>
        <input id="application" type="text" placeholder="e.g. app-a" />
      </div>
      <div class="col">
        <label for="journal">Journal</label>
        <input id="journal" type="text" placeholder="e.g. 42" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="correctionText">Correction Text</label>
        <textarea id="correctionText" placeholder="Paste corrected summary text"></textarea>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button id="btnTriggerMedsum">Trigger summary correction</button>
        <button id="btnShowCurl" class="secondary">Show cURL (fallback)</button>
      </div>
    </div>
    <p class="help">If the browser blocks cross-origin requests, use the generated cURL command instead to trigger the API and then click "Check result" above.</p>
  </div>

  <div class="card" data-section="api">
    <h2>Generate Summary via MedSum API</h2>
    <div class="row">
      <div class="col">
        <label for="sumApiUrl">MedSum API URL</label>
        <input id="sumApiUrl" type="text" placeholder="http://localhost:3000" value="http://localhost:3000" />
      </div>
      <div class="col">
        <label for="sumApiKey">x-api-key</label>
        <input id="sumApiKey" type="text" placeholder="client api key" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="sumApplication">Application</label>
        <input id="sumApplication" type="text" placeholder="e.g. app-a" value="client-a" />
      </div>
      <div class="col">
        <label for="sumJournal">Journal</label>
        <input id="sumJournal" type="text" placeholder="e.g. 42" value="42" />
      </div>
      <div class="col">
        <label for="sumLanguage">Language</label>
        <input id="sumLanguage" type="text" placeholder="se" value="se" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="sumJournalForm">Journal Form (JSON)</label>
        <textarea id="sumJournalForm" placeholder="{}">{}</textarea>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="sumText">Text</label>
        <textarea id="sumText" placeholder="Paste text to summarize"></textarea>
      </div>
      <div class="col">
        <label for="sumDictation">Text Dictation (optional)</label>
        <textarea id="sumDictation" placeholder="Optional dictation"></textarea>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button id="btnGenerateSummary">Generate summary</button>
        <button id="btnShowSummaryCurl" class="secondary">Show cURL (summary)</button>
        <button id="btnShowCorrectionCurl" class="secondary">Show cURL (correction)</button>
      </div>
    </div>
    <p class="help">On success, the Original and Summary fields above are populated so you can upload and trigger analytics without relying on pub/sub.</p>
    <label>Last cURL</label>
    <pre id="curlOut" class="status" style="background:#fbfbfb"></pre>
    <button id="btnCopyCurl" class="secondary">Copy cURL</button>
  </div>

  <div class="card">
    <h2>Response</h2>
    <pre id="respOut" class="status"></pre>
  </div>

  

  <script>
    const status = document.getElementById('status');
    const respOut = document.getElementById('respOut');

    function log(msg) {
      status.textContent = `${new Date().toLocaleTimeString()} \u2022 ${msg}\n` + status.textContent;
    }
    function setCurlOut(cmd) {
      const el = document.getElementById('curlOut');
      if (el) el.textContent = cmd;
    }

    async function uploadFiles() {
      const job = jobEl.value.trim();
      const original = originalEl.value;
      const summary = summaryEl.value;
      if (!job) { log('Job is required'); return; }
      if (!original || !summary) { log('Both original and summary must be provided'); return; }

      const fd = new FormData();
      fd.append('job', job);
      const originalFile = new File([original], `${job}_original.txt`, { type: 'text/plain' });
      const correctedFile = new File([summary], `${job}_corrected.txt`, { type: 'text/plain' });
      fd.append('originalFile', originalFile);
      fd.append('correctedFile', correctedFile);

      const res = await fetch('/summary-analysis/upload', { method: 'POST', body: fd });
      const json = await res.json().catch(() => ({}));
      if (res.ok) {
        log(`Uploaded: ${JSON.stringify(json.files || [])}`);
      } else {
        log(`Upload failed: ${json.error || res.status}`);
      }
    }

    async function triggerAnalysis() {
      const job = jobEl.value.trim();
      if (!job) { log('Job is required'); return; }
      const res = await fetch(`/summary-analysis/trigger/${encodeURIComponent(job)}`, { method: 'POST' });
      const json = await res.json().catch(() => ({}));
      if (res.ok) {
        log('Triggered summary_complete publish');
      } else {
        log(`Trigger failed: ${json.error || res.status}`);
      }
    }

    async function checkResult() {
      const job = jobEl.value.trim();
      if (!job) { log('Job is required'); return; }
      const res = await fetch(`/summary-analysis/${encodeURIComponent(job)}`);
      const json = await res.json().catch(() => ({}));
      if (res.ok && json) {
        werEl.textContent = json.wer ?? '-';
        cerEl.textContent = json.cer ?? '-';
        bleuEl.textContent = json.bleu ?? '-';
        const md = json.metadata || {};
        document.getElementById('meta_job_id').textContent = md.job_id ?? '-';
        document.getElementById('meta_model_id').textContent = md.model_id ?? '-';
        document.getElementById('meta_prompt_id').textContent = md.prompt_id ?? '-';
        document.getElementById('meta_client_id').textContent = md.client_id ?? '-';
        document.getElementById('meta_explanations').textContent = Array.isArray(md.explanation_ids) ? md.explanation_ids.join(', ') : '-';
        document.getElementById('meta_json').textContent = JSON.stringify(md, null, 2);
        log('Fetched analysis result');
      } else {
        log(`Result not available: ${json.error || res.status}`);
      }
    }

    // removed analytics handlers

    async function triggerMedsumCorrection() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();
      const application = document.getElementById('application').value.trim();
      const journal = document.getElementById('journal').value.trim();
      const text = document.getElementById('correctionText').value;
      if (!apiUrl || !apiKey || !application || !journal || !text) {
        log('All MedSum API fields are required');
        return;
      }

      const url = `${apiUrl}/v1/text/summary/correction`;
      const body = { application, journal: Number(journal), text };
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
          },
          body: JSON.stringify(body),
        });
        const json = await res.json().catch(() => ({}));
        if (res.ok) {
          log('Triggered MedSum API correction; published summary_complete (if feature enabled).');
          // Heuristic: analytics stores file_name extracted from summary path. Current extractor uses the directory name when present.
          // With MedSum API filenames "application/journal_uuid_correction.txt", analytics stores file_name = application.
          jobEl.value = application;
        } else {
          log(`MedSum API error: ${json.message || res.status}`);
        }
      } catch (e) {
        log(`MedSum API request failed (likely CORS). Use cURL fallback.`);
      }
    }

    function showCurlFallback() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();
      const application = document.getElementById('application').value.trim();
      const journal = document.getElementById('journal').value.trim();
      const text = document.getElementById('correctionText').value;
      const payload = JSON.stringify({ application, journal: Number(journal), text }).replace(/"/g, '\\"');
      const cmd = `curl -X POST \n  -H "Content-Type: application/json" \n  -H "x-api-key: ${apiKey}" \n  -d "${payload}" \n  ${apiUrl}/v1/text/summary/correction`;
      setCurlOut(cmd);
      log('Generated cURL for summary correction');
    }

    document.getElementById('btnTriggerMedsum').addEventListener('click', triggerMedsumCorrection);
    document.getElementById('btnShowCurl').addEventListener('click', showCurlFallback);

    async function createClientAndFetchKey() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const adminKey = document.getElementById('adminApiKey').value.trim();
      const clientName = document.getElementById('clientName').value.trim();
      if (!apiUrl || !adminKey || !clientName) { log('API URL, admin key and client name are required'); return; }
      const url = `${apiUrl}/internal/client`;
      const body = { name: clientName };
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': adminKey },
          body: JSON.stringify(body),
        });
        const text = await res.text();
        let json = {};
        try { json = JSON.parse(text); } catch {}
        if (res.ok && json && json.key) {
          document.getElementById('apiKey').value = json.key;
          document.getElementById('application').value = clientName;
          document.getElementById('sumApiKey').value = json.key;
          document.getElementById('sumApplication').value = clientName;
          jobEl.value = clientName;
          log(`Client created and bucket provisioned; x-api-key set for ${clientName}`);
        } else {
          const msg = json.message || text || `HTTP ${res.status}`;
          const hint = res.status === 401 ? 'Hint: ADMIN_API_KEY mismatch in MedSum API or header missing' : '';
          log(`Client creation failed: ${msg}. ${hint}`);
        }
      } catch (e) {
        log(`Create client failed: ${e instanceof Error ? e.message : 'Unknown error'} (possible CORS). Use cURL instead.`);
      }
    }

    function showClientCurl() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const adminKey = document.getElementById('adminApiKey').value.trim();
      const clientName = document.getElementById('clientName').value.trim();
      const payload = JSON.stringify({ name: clientName }).replace(/"/g, '\\"');
      const cmd = `curl -X POST\n  -H "Content-Type: application/json"\n  -H "x-api-key: ${adminKey}"\n  -d "${payload}"\n  ${apiUrl}/internal/client`;
      log(cmd);
    }

    document.getElementById('btnCreateClient').addEventListener('click', createClientAndFetchKey);
    document.getElementById('btnShowClientCurl').addEventListener('click', showClientCurl);
    document.getElementById('btnListClients').addEventListener('click', async () => {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const adminKey = document.getElementById('adminApiKey').value.trim();
      try {
        const res = await fetch(`${apiUrl}/internal/clients`, { headers: { 'x-api-key': adminKey } });
        const text = await res.text();
        log(`Clients: ${text}`);
      } catch (e) {
        log(`List clients failed: ${e instanceof Error ? e.message : 'Unknown error'}`);
      }
    });

    async function generateSummaryViaMedsum() {
      const apiUrl = document.getElementById('sumApiUrl').value.trim();
      const apiKey = document.getElementById('sumApiKey').value.trim();
      const application = document.getElementById('sumApplication').value.trim();
      const journal = document.getElementById('sumJournal').value.trim();
      const language = document.getElementById('sumLanguage').value.trim();
      let journalFormRaw = document.getElementById('sumJournalForm').value;
      const text = document.getElementById('sumText').value;
      const text_dictation = document.getElementById('sumDictation').value;
      if (!apiUrl || !apiKey || !application || !journal || !language) {
        log('All summary fields are required (dictation optional)');
        return;
      }
      let journalForm = {};
      try { journalForm = JSON.parse(journalFormRaw || '{}'); } catch { log('Invalid journalForm JSON'); return; }
      const url = `${apiUrl}/v1/text/summary`;
      const body = { application, journal: Number(journal), journalForm, language, text, text_dictation };
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
          body: JSON.stringify(body),
        });
        const json = await res.json().catch(() => ({}));
        if (res.ok && json.summary) {
          originalEl.value = text || text_dictation || '';
          summaryEl.value = json.summary;
          // Heuristic set job to application as analytics stores directory name
          jobEl.value = application;
          log('Summary generated via MedSum API; fields populated for upload/trigger');
        } else {
          log(`Summary generation failed: ${json.message || res.status}`);
        }
      } catch (e) {
        log('MedSum API request failed (likely CORS). Use cURL summary fallback.');
      }
    }

    function showSummaryCurl() {
      const apiUrl = document.getElementById('sumApiUrl').value.trim();
      const apiKey = document.getElementById('sumApiKey').value.trim();
      const application = document.getElementById('sumApplication').value.trim();
      const journal = document.getElementById('sumJournal').value.trim();
      const language = document.getElementById('sumLanguage').value.trim();
      let journalFormRaw = document.getElementById('sumJournalForm').value;
      const text = document.getElementById('sumText').value;
      const text_dictation = document.getElementById('sumDictation').value;
      const payloadObj = { application, journal: Number(journal), journalForm: (() => { try { return JSON.parse(journalFormRaw || '{}'); } catch { return {}; } })(), language, text, text_dictation };
      const payload = JSON.stringify(payloadObj).replace(/"/g, '\\"');
      const cmd = `curl -X POST \n  -H "Content-Type: application/json" \n  -H "x-api-key: ${apiKey}" \n  -d "${payload}" \n  ${apiUrl}/v1/text/summary`;
      setCurlOut(cmd);
      log('Generated cURL for summary generation');
    }

    function showCorrectionCurl() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();
      const application = document.getElementById('application').value.trim();
      const journal = document.getElementById('journal').value.trim();
      const text = document.getElementById('correctionText').value;
      const payload = JSON.stringify({ application, journal: Number(journal), text }).replace(/"/g, '\\"');
      const cmd = `curl -X POST \n  -H "Content-Type: application/json" \n  -H "x-api-key: ${apiKey}" \n  -d "${payload}" \n  ${apiUrl}/v1/text/summary/correction`;
      setCurlOut(cmd);
      log('Generated cURL for correction');
    }

    document.getElementById('btnGenerateSummary').addEventListener('click', generateSummaryViaMedsum);
    document.getElementById('btnShowSummaryCurl').addEventListener('click', showSummaryCurl);
    document.getElementById('btnShowCorrectionCurl').addEventListener('click', showCorrectionCurl);
    document.getElementById('btnCopyCurl').addEventListener('click', () => {
      const el = document.getElementById('curlOut');
      if (el && el.textContent) {
        navigator.clipboard.writeText(el.textContent);
        log('Copied cURL to clipboard');
      }
    });

    
    // Tabs toggle
    document.getElementById('btnClearStatus').addEventListener('click', () => { status.textContent = ''; respOut.textContent = '' });
  </script>
</body>
</html>

